services:
  # 1. SQL Server Database
  mssql:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      ACCEPT_EULA: "1"
      SA_PASSWORD: "YourSecurePassword123!"
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourSecurePassword123!" -Q "SELECT 1" || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - app-network

  # 2. Django Backend (Core App) - Port 8000
  backend-core:
    build:
      context: ./backend_py
      dockerfile: Dockerfile
    command: python manage.py runserver 0.0.0.0:8000
    ports:
      - "8000:8000"
    environment:
      DEBUG: "False"
      ALLOWED_HOSTS: "*"
      DATABASE_URL: "mssql+pyodbc://sa:YourSecurePassword123!@mssql:1433/Floria_2?driver=ODBC+Driver+17+for+SQL+Server&TrustServerCertificate=yes"
      SECRET_KEY: "your-secret-key-change-in-production"
      JWT_SECRET: "floria-super-secure-secret-key-min-32-chars-2024!"
    depends_on:
      mssql:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # 3. FastAPI Auth Service - Port 8001
  backend-auth:
    build:
      context: ./backend_py
      dockerfile: Dockerfile
    command: uvicorn services.auth.main:app --host 0.0.0.0 --port 8001
    ports:
      - "8001:8001"
    environment:
      DEBUG: "False"
      DATABASE_URL: "mssql+pyodbc://sa:YourSecurePassword123!@mssql:1433/Floria_2?driver=ODBC+Driver+17+for+SQL+Server&TrustServerCertificate=yes"
      JWT_SECRET: "floria-super-secure-secret-key-min-32-chars-2024!"
    depends_on:
      mssql:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # 4. FastAPI Service Layer (Search/Analytics) - Port 8002
  backend-service:
    build:
      context: ./backend_py
      dockerfile: Dockerfile
    command: uvicorn services.main:app --host 0.0.0.0 --port 8002
    ports:
      - "8002:8002"
    environment:
      DEBUG: "False"
      DB_HOST: "mssql"
      DB_NAME: "Floria_2"
      DB_USER: "sa"
      DB_PASSWORD: "YourSecurePassword123!"
    depends_on:
      mssql:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # 5. Flutter Web Frontend - Port 80
  frontend-web:
    build:
      context: .
      dockerfile: Dockerfile.web
    ports:
      - "80:80"
    depends_on:
      - backend-core
      - backend-auth
      - backend-service
    networks:
      - app-network
    restart: unless-stopped

volumes:
  mssql_data:

networks:
  app-network:
    driver: bridge
